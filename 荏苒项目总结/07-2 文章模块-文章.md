# 文章模块-文章相关

## 显示、添加、删除当前文集的文章列表

+ views视图

  ```python
  from rest_framework.viewsets import ModelViewSet
  from .models import Article
  from .serializers import ArticleModelSerializer
  from rest_framework.response import Response
  class ArticleModelViewSet(ModelViewSet):
      serializer_class = ArticleModelSerializer
      permission_classes = [IsAuthenticated]
  
      def list(self, request, *args, **kwargs):
          collection_id = request.query_params.get("collection")
          user = request.user
          queryset = Article.objects.filter(is_delete=False, user=user, collection_id=collection_id).order_by("orders",
                                                                                                              "-id")
          serializer = self.get_serializer(queryset, many=True)
          return Response(serializer.data)
  
      def get_queryset(self):
          user = self.request.user
          """重写queryset属性值"""
          ret = Article.objects.filter(user=user).order_by("orders", "-id")
          return ret
  ```

+ serializers序列化器

  ```python
  from .models import Article
  from datetime import datetime
  class ArticleModelSerializer(serializers.ModelSerializer):
      """文章的序列化器"""
      position = serializers.BooleanField(write_only=True, label="添加文章的位置")
      class Meta:
          model = Article
          fields = ["id","name","content","collection","position","is_public"]
          read_only_fields = ["id","name","content","is_public"]
  
      def create(self, validated_data):
          """保存数据"""
          name = datetime.now().strftime("%Y-%m-%d")
          collection = validated_data.get("collection")
          user = self.context["request"].user
          try:
              article = Article.objects.create(
                  name=name,
                  orders=0,
                  user=user,
                  collection=collection
              )
          except:
              raise serializers.ValidationError("对不起, 添加文章失败!")
  
          position = validated_data.get("position")
          if position:
              """如果是下方添加,则把id设置为orders为id"""
              article.orders = article.id
              article.save()
          return article
  ```

+ urls 路由

  ```python
  urlpatterns = [
      path("collection/", views.MyCollectionListAPIView.as_view()),
      path("collection/create/", views.CollectionCreateAPIView.as_view()),
      re_path("^collection/(?P<pk>\d+)/$", views.CollectionRetrieveUpdateDestroyAPIView.as_view()),
      # 文章相关
      path("", views.ArticleModelViewSet.as_view({"get": "list", "post": "create"})),
      re_path("^(?P<pk>\d+)/$", views.ArticleModelViewSet.as_view({"delete":"destroy"})),
  ]
  ```

+ writer组件

  ```vue
  <template>
    <div class="write" v-show="is_show_page">
      <div class="_2v5v5">
        <div class="_3zibT">
          <router-link to="/">回首页</router-link>
        </div>
        <div class="_1iZMb">
          <div class="_33Zlg" @click="collection_form=true"><i class="fa fa-plus"></i><span>新建文集</span></div>
          <div class="_2G97m">
            <form class="M8J6Q" :class="collection_form?'_2a1Rp':'_1mU5v'">
              <input type="text" placeholder="请输入文集名..." v-model="collection_name" class="_1CtV4">
              <button type="button" class="dwU8Q _3zXcJ _3QfkW" @click="collection_add"><span>提 交</span></button>
              <button type="button" class="vIzwB _3zXcJ" @click="collection_form=false"><span>取 消</span></button>
            </form>
          </div>
        </div>
        <ul class="_3MbJ4 _3t059">
          <li class="_3DM7w" :class="{_31PCv:current_collection==key}" 　:title="collection.name"
              v-for="collection,key in collection_list" :key="key">
            <div class="_3P4JX _2VLy-" v-if="current_collection==key"
                 @click.stop.prevent="is_show_collection_menu=!is_show_collection_menu">
              <i class="fa fa-gear"></i>
              <span>
                <ul class="_2V8zt _3FcHm _2w9pn" :class="{NvfK4:is_show_collection_menu}">
                  <li class="_2po2r cRfUr" title="" @click="edit_collection(collection.id)">
                    <span class=""><i class="fa fa-pencil-square-o _22XWG"></i>修改文集</span>
                  </li>
                  <li class="_2po2r cRfUr" title="" @click="del_collection(collection.id)">
                    <span class=""><i class="fa fa-trash-o _22XWG"></i>删除文集</span>
                  </li>
                </ul>
              </span>
            </div>
            <span @click="current_collection=key">{{collection.name}}</span>
          </li>
        </ul>
        <div style="height: 50px;"></div>
        <div role="button" class="h-5Am">
          <span class="ant-dropdown-trigger"><i class="fa fa-bars"></i><span>设置</span></span>
          <span class="Yv5Zx">遇到问题<i class="fa fa-question-circle-o"></i></span>
        </div>
      </div>
      <div class="rQQG7">
        <div class="_3revO _2mnPN">
          <div class="_3br9T">
            <div>
              <div class="_1GsW5" @click="add_article(0)"><i class="fa fa-plus-circle"></i><span> 新建文章</span></div>
              <ul class="_2TxA-">
                <li class="_25Ilv" :class="{_33nt7:current_article==key}" :title="article.name"
                    v-for="article,key in article_list" :key="key" @click="current_article=key">
                  <i class="_13kgp" :class="{_2m93u:article.is_public}"></i>
                  <div class="_3P4JX poOXI" v-if="current_article==key"
                       @click.stop="is_show_article_menu=!is_show_article_menu">
                    <i class="fa fa-gear"></i>
                    <span>
                      <ul class="_2V8zt _3FcHm _2w9pn" :class="{NvfK4:is_show_article_menu}">
                        <li class="_2po2r cRfUr" title="" v-if="!article.is_public"><span class=""><i
                          class="fa fa-share _22XWG" ></i>直接发布</span></li>
                        <li class="_2po2r cRfUr" title="" v-if="article.is_public"><span class=""><i
                          class="fa fa-lock _22XWG" ></i>设置隐私</span></li>
                        <li class="_2po2r cRfUr" title=""><span class=""><i
                          class="fa fa-clock-o _22XWG"></i>定时发布</span></li>
                        <li class="_2po2r cRfUr" title=""><span class="_20tIi"><i class="iconfont ic-paid _22XWG"></i>发布为付费文章</span></li>
                        <li class="_2po2r cRfUr" title=""><span class=""><i
                          class="iconfont ic-set _22XWG"></i>设置发布样式</span></li>
                        <li class="_3nZXj _2_WAp _3df2u _2po2r cRfUr" title=""><span class=""><i
                          class="fa fa-folder-open _22XWG"></i>移动文章
                          <div class="_3x4X_">
                            <ul class="_2KzJx oGKRI _3DXDE _2w9pn">
                              <li class="_2po2r cRfUr" title="随笔"><span class="">随笔</span></li>
                            </ul>
                          </div>
                        </span>
                        </li>
                        <li class="_2po2r cRfUr" title=""><span class=""><i
                          class="fa fa-history _22XWG"></i>历史版本</span></li>
                        <li class="_2po2r cRfUr" title="" @click="del_article(article.id)"><span class=""><i
                          class="fa fa-trash-o _22XWG"></i>删除文章</span></li>
                        <li class="_2po2r cRfUr" title=""><span class=""><i
                          class="fa fa-ban _22XWG"></i>设置禁止转载</span></li>
                      </ul>
                    </span>
                  </div>
                  <span class="NariC">{{article.name}}</span>
                  <span class="hLzJv">{{article.content}}</span>
                  <span class="_29C-V">字数:{{article.content?article.content.length:0}}</span>
                </li>
              </ul>
              <div class="_2cVn3" @click="add_article(1)"><i class="fa fa-plus"></i><span> 在下方新建文章</span></div>
            </div>
          </div>
        </div>
        <input type="text" class="_24i7u" value="2020-01-12" v-if="article_list.length>0">
        <div id="editor" v-if="article_list.length>0">
          <mavon-editor
            style="height: 100%"
            v-model="editorContent"
            :ishljs="true"
            ref=md
            @imgAdd="imgAdd"
            @imgDel="imgDel"
          ></mavon-editor>
        </div>
      </div>
    </div>
  </template>
  <script>
      import {mavonEditor} from 'mavon-editor'
      import 'mavon-editor/dist/css/index.css'
  
      export default {
          name: "Write",
          data() {
              return {
                  editorContent: "",
                  img_file: [],
                  collection_form: false,
                  is_show_page: false,
                  token: "",
                  collection_list: [],     // 当前用户的文集列表
                  current_collection: 0,  // 默认让用户选中的文集的下标为0
                  is_show_collection_menu: false,    // 是否显示文集菜单
                  collection_name: "",//新建文集name
                  article_list: [],
                  current_article: 0,     // 默认让用户选中的文章的下标为0
                  is_show_article_menu: false,    // 是否显示文章菜单
              }
          },
          watch: {
              editorContent() {
                  console.log(this.editorContent)
              },
              current_collection() {
                  let collection_id = this.collection_list[this.current_collection].id;
                  this.get_article_list(collection_id);
                  this.current_article = 0;
              },
              collection_list(){
  
                  this.get_article_list();
              },
              current_article(){
                  this.editorContent = this.article_list[this.current_article].content;
              }
  
          },
          created() {
              this.token = this.$settings.check_user_login(this);
              if (this.token) {
                  this.is_show_page = true;
                  this.get_collection();
  
              }
          },
          mounted() {
  
              if (this.article_list.length > 0) {
                  document.querySelector("#editor").style.height = document.documentElement.clientHeight - document.querySelector("._24i7u").clientHeight + "px";
              }
              // 给当前网页绑定点击事件
              document.onclick = () => {
                  // 点击文档,隐藏操作文集的的菜单
                  this.is_show_collection_menu = false;
                  this.is_show_article_menu = false;
              }
          },
          components: {
              mavonEditor
          },
          methods: {
              // 绑定@imgAdd event
              imgAdd(pos, $file) {
                  // 添加文件
              },
              imgDel(pos) {
                  // 删除文件
              },
              get_collection() {
                  // 获取当前登陆用户的文集
                  this.$axios.get(`${this.$settings.Host}/article/collection/`, {
                      headers: {
                          Authorization: "jwt " + this.token,
                      }
                  }).then(response => {
                      this.collection_list = response.data;
                  }).catch(error => {
                      this.$message.error("对不起,无法获取当前用户的文集列表!");
                      this.$settings.jump_page(this, "尊敬的游客, 您尚未登陆!请登陆后再进行操作!", "警告", "去登陆", "/user/login");
                  });
              },
              collection_add() {
                  if (!this.collection_name) {
                      this.$message.error("文集名称不能为空！")
                  } else {
                      this.$axios.post(`${this.$settings.Host}/article/collection/create/`, {
                          name: this.collection_name,
                      }, {
                          headers: {
                              Authorization: "jwt " + this.token,
                          }
                      }).then(response => {
                          this.$message.success("添加文集成功！");
                          this.collection_name = '';
                          this.collection_form = false;
                          this.get_collection();
                          this.current_collection = 0;
                      }).catch(error => {
                          this.$message.error("添加文集失败！");
                      });
                  }
              },
              edit_collection(collection_id) {
                  // 修改文集
                  this.$prompt('请输入新文集名', '提示', {
                      confirmButtonText: '确定',
                      cancelButtonText: '取消',
                      inputPattern: /.{1,}/,
                      inputErrorMessage: '文集名称不能为空!'
                  }).then(({value}) => {
                      // 点击确定,需要把当前文集名称提交到服务端进行修改
                      this.$axios.put(`${this.$settings.Host}/article/collection/${collection_id}/`, {
                          name: value,
                      }, {
                          headers: {
                              Authorization: "jwt " + this.token,
                          }
                      }).then(response => {
                          this.get_collection();
                      }).catch(error => {
                          this.$message.error(error.response.data);
                      })
                  }).catch(() => {
  
                  });
              },
              del_collection(collection_id) {
                  // 删除文集
                  this.$axios.delete(`${this.$settings.Host}/article/collection/${collection_id}/`, {
                      headers: {
                          Authorization: "jwt " + this.token,
                      }
                  }).then(response => {
                      this.get_collection();
                  }).catch(error => {
                      this.$message.error(error.response.data);
                  })
  
              },
              get_article_list() {
                  // 获取文章列表
                  let collection_id = this.collection_list[this.current_collection].id;
                  this.$axios.get(`${this.$settings.Host}/article/`, {
                      params: {
                          collection: collection_id,
                      },
                      headers: {
                          Authorization: "jwt " + this.token,
                      }
                  }).then(response => {
                      this.article_list = response.data;
                  }).catch(error => {
                      this.$message.error(error.response.data);
                  })
              },
              add_article(position) { // position 表示添加文章位置
                  // 在前面添加文章
                  this.$axios.post(`${this.$settings.Host}/article/`, {
                      position: position,
                      collection: this.collection_list[this.current_collection].id,
                  }, {
                      headers: {
                          Authorization: "jwt " + this.token,
                      }
                  }).then(response => {
                      let collection_id = this.collection_list[this.current_collection].id;
                      this.get_article_list(collection_id);
                  }).catch(error => {
                      this.$message.error(error.response.data);
                  })
              },
              del_article(article_id) {
                  // 删除文集
                  this.$axios.delete(`${this.$settings.Host}/article/${article_id}/`, {
                      headers: {
                          Authorization: "jwt " + this.token,
                      }
                  }).then(response => {
                      this.get_article_list();
                  }).catch(error => {
                      this.$message.error(error.response.data);
                  })
  
              },
          }
      }
  </script>
  ```

  

## 文章发布

默认情况下，我们的文章属于未发布状态下的，这时候除了作者本人和后台管理员，其他人看不到的。

1. 在写文章页面，我们需要给用户区分哪些文章已经发布了，哪些文章没有发布。
2. 在写文章页面，提供一个api，用于修改发布状态。同时，需要提供发布后的文章页面。

### 显示文章的发布状态

文章的发布状态，是通过文章的图标来进行区分的。所以我们需要修改当前文集的文章列表时需要新增返回一个字段is_public，接着在客户端中根据is_public来显示不同图标即可。

在服务端的序列化器 article/serialziers.py，代码：

```python
#同上
```

### 切换文章的发布状态

服务端提供切换文章发布状态的功能。

+ views视图代码

  ```python
  from rest_framework.views import APIView
  from rest_framework import status
  class ArticlePublicStatusAPIView(APIView):
      """切换文章的发布状态"""
      permission_classes = [IsAuthenticated]
      def put(self,request,pk):
          user = request.user
          try:
              article = Article.objects.get(pk=pk,user=user)
          except Article.DoesNotExist:
              return Response("对不起,当前文章不存在!", status=status.HTTP_400_BAD_REQUEST)
          article.is_public = not article.is_public
          article.pub_date = None
          article.save()
          return Response("操作成功!")
  ```

+ urls 路由

  ```python
  urlpatterns = [
      path("collection/", views.MyCollectionListAPIView.as_view()),
      path("collection/create/", views.CollectionCreateAPIView.as_view()),
      re_path("^collection/(?P<pk>\d+)/$", views.CollectionRetrieveUpdateDestroyAPIView.as_view()),
      # 文章相关
      path("", views.ArticleModelViewSet.as_view({"get": "list", "post": "create"})),
      re_path("^(?P<pk>\d+)/$", views.ArticleModelViewSet.as_view({"delete": "destroy"})),
      # 切换文章发布状态
      re_path("^public/(?P<pk>\d+)/$", views.ArticlePublicStatusAPIView.as_view()),
  ]
  ```

+ writer组件

  ```vue
  <template>
    ……
  
                        <li class="_2po2r cRfUr" title="" v-if="!article.is_public"
                            @click="public_article(article.is_public)"><span class=""><i
                          class="fa fa-share _22XWG"></i>直接发布</span></li>
                        <li class="_2po2r cRfUr" title="" v-if="article.is_public"
                            @click="public_article(article.is_public)"><span class=""><i
                          class="fa fa-lock _22XWG"></i>设置隐私</span></li>
  
  ……
  </template>
  <script>
  
              public_article(is_public) {
                  // 文章发布状态的切换
                  let article_id = this.article_list[this.current_article].id;
                  this.$axios.put(`${this.$settings.Host}/article/public/${article_id}/`, {
                      // is_public: is_public,
                  }, {
                      headers: {
                          Authorization: "jwt " + this.token,
                      }
                  }).then(response => {
                      this.get_article_list();
                      if (!is_public) {
                          this.$message.success("文章发布成功!");
                          // todo 接下来我们还需要对页面进行跳转到文章发布投稿页面
                      } else {
                          this.$message.success("文章设置成功!");
                      }
                  }).catch(error => {
                      this.$message.error("操作失败!请联系客服工作人员!");
                  })
              },
          }
      }
  </script>
  ```

## 移动文章

首先修复文章菜单中的文集列表，在css代码中这个位置放置以下代码：

```css
._2_WAp ._2KzJx, ._2_WAp ._3x4X_ {
    position: absolute;
    right: 100%;
    top: 0;
    display: none;
}
._2_WAp:hover ._2KzJx, ._2_WAp:hover ._3x4X_ {
    display: block;
}

# 修改组件的316和511代码中的宽度从16.66666667%改成13.6666667%：
.h-5Am {
    display: block;
    width: 13.66666667%;
    ....
}

```

+ views视图

  ```python
  class ArticlechangeCollection(APIView):
      """移动文章"""
      permission_classes = [IsAuthenticated]
  
      def put(self, request, pk):
          user = request.user
          collection_id = request.data.get("collection_id")
          try:
              article = Article.objects.get(pk=pk, user=user)
              ArticleCollection.objects.get(pk=collection_id, user=user)
          except Article.DoesNotExist:
              return Response("对不起,当前文章或文集不存在!", status=status.HTTP_400_BAD_REQUEST)
          article.collection_id = int(collection_id)
          article.save()
          return Response("操作成功!")
  ```

+ urls 路由

  ```python
  urlpatterns = [
  	……
      # 移动文章所在文集
      re_path("^move/(?P<pk>\d+)/$", views.ArticlechangeCollection.as_view()),
  ]
  ```

+ writer组件

  ```vue
  <template>
  ……
                              <li class="_2po2r cRfUr" :title="collection.name" v-for="collection in collection_list"
                                  v-if="collection.id!=article.collection" @click="move_article(collection.id)"><span
                                class="">{{collection.name}}</span></li>
  ……
  </template>
  <script>
  
          watch: {
              article_list(){
                  if(this.current_article===this.article_list.length){
                      this.current_article = this.current_article -1;
                  }
              },
  
          },
  
          methods: {
              move_article(collection_id) {
                  // 文章发布状态的切换
                  let article_id = this.article_list[this.current_article].id;
                  this.$axios.put(`${this.$settings.Host}/article/move/${article_id}/`, {
                      collection_id: collection_id,
                  }, {
                      headers: {
                          Authorization: "jwt " + this.token,
                      }
                  }).then(response => {
                      this.get_article_list();
                      this.$message.success("文章设置成功!");
  
                  }).catch(error => {
                      this.$message.error("操作失败!请联系客服工作人员!");
                  })
              }
          }
      }
  </script>
  ```

## 定时发布[扩展知识点]

```
原理：使用celery完成定时任务！
步骤：
1. 当用户点选了定时发布, 页面中弹出一个选择时间的窗口。
2. 当用户设置完成发布时间以后，点击“确认”以后,把这个时间和文章id发送到服务端。
3. 服务端中文章模型的pub_date记录这个定时发布时间。
4. 在celery中创建一个定时任务，在每个固定时间段，检查文章表中，对应时间段的pub_date把对应的文章进行发布。
```

### 前端writer组价增加一个选择时间的弹窗

```vue
<template>
  <div class="write" v-show="is_show_page">
    <div class="_2v5v5">
      <div class="_3zibT">
        <router-link to="/">回首页</router-link>
      </div>
      <div class="_1iZMb">
        <div class="_33Zlg" @click="collection_form=true"><i class="fa fa-plus"></i><span>新建文集</span></div>
        <div class="_2G97m">
          <form class="M8J6Q" :class="collection_form?'_2a1Rp':'_1mU5v'">
            <input type="text" placeholder="请输入文集名..." v-model="collection_name" class="_1CtV4">
            <button type="button" class="dwU8Q _3zXcJ _3QfkW" @click="collection_add"><span>提 交</span></button>
            <button type="button" class="vIzwB _3zXcJ" @click="collection_form=false"><span>取 消</span></button>
          </form>
        </div>
      </div>
      <ul class="_3MbJ4 _3t059">
        <li class="_3DM7w" :class="{_31PCv:current_collection==key}" 　:title="collection.name"
            v-for="collection,key in collection_list" :key="key">
          <div class="_3P4JX _2VLy-" v-if="current_collection==key"
               @click.stop.prevent="is_show_collection_menu=!is_show_collection_menu">
            <i class="fa fa-gear"></i>
            <span>
              <ul class="_2V8zt _3FcHm _2w9pn" :class="{NvfK4:is_show_collection_menu}">
                <li class="_2po2r cRfUr" title="" @click="edit_collection(collection.id)">
                  <span class=""><i class="fa fa-pencil-square-o _22XWG"></i>修改文集</span>
                </li>
                <li class="_2po2r cRfUr" title="" @click="del_collection(collection.id)">
                  <span class=""><i class="fa fa-trash-o _22XWG"></i>删除文集</span>
                </li>
              </ul>
            </span>
          </div>
          <span @click="current_collection=key">{{collection.name}}</span>
        </li>
      </ul>
      <div style="height: 50px;"></div>
      <div role="button" class="h-5Am">
        <span class="ant-dropdown-trigger"><i class="fa fa-bars"></i><span>设置</span></span>
        <span class="Yv5Zx">遇到问题<i class="fa fa-question-circle-o"></i></span>
      </div>
    </div>
    <div class="rQQG7">
      <div class="_3revO _2mnPN">
        <div class="_3br9T">
          <div>
            <div class="_1GsW5" @click="add_article(0)"><i class="fa fa-plus-circle"></i><span> 新建文章</span></div>
            <ul class="_2TxA-">
              <li class="_25Ilv" :class="{_33nt7:current_article==key}" :title="article.name"
                  v-for="article,key in article_list" :key="key" @click="current_article=key">
                <i class="_13kgp" :class="{_2m93u:article.is_public}"></i>
                <div class="_3P4JX poOXI" v-if="current_article==key"
                     @click.stop="is_show_article_menu=!is_show_article_menu">
                  <i class="fa fa-gear"></i>
                  <span>
                    <ul class="_2V8zt _3FcHm _2w9pn" :class="{NvfK4:is_show_article_menu}">
                      <li class="_2po2r cRfUr" title="" v-if="!article.is_public"
                          @click="public_article(article.is_public)"><span class=""><i
                        class="fa fa-share _22XWG"></i>直接发布</span></li>
                      <li class="_2po2r cRfUr" title="" v-if="article.is_public"
                          @click="public_article(article.is_public)"><span class=""><i
                        class="fa fa-lock _22XWG"></i>设置隐私</span></li>
                      <li class="_2po2r cRfUr" title="" v-if="!article.is_public" @click="dialogVisible = true"><span class=""><i
                        class="fa fa-clock-o _22XWG"></i>定时发布</span></li>
                      <li class="_2po2r cRfUr" title=""><span class="_20tIi"><i class="iconfont ic-paid _22XWG"></i>发布为付费文章</span></li>
                      <li class="_2po2r cRfUr" title=""><span class=""><i
                        class="iconfont ic-set _22XWG"></i>设置发布样式</span></li>
                      <li class="_3nZXj _2_WAp _3df2u _2po2r cRfUr" title=""><span class=""><i
                        class="fa fa-folder-open _22XWG"></i>移动文章
                        <div class="_3x4X_">
                          <ul class="_2KzJx oGKRI _3DXDE _2w9pn">
                            <li class="_2po2r cRfUr" :title="collection.name" v-for="collection in collection_list"
                                v-if="collection.id!=article.collection" @click="move_article(collection.id)"><span
                              class="">{{collection.name}}</span></li>
                          </ul>
                        </div>
                      </span>
                      </li>
                      <li class="_2po2r cRfUr" title=""><span class=""><i
                        class="fa fa-history _22XWG"></i>历史版本</span></li>
                      <li class="_2po2r cRfUr" title="" @click="del_article(article.id)"><span class=""><i
                        class="fa fa-trash-o _22XWG"></i>删除文章</span></li>
                      <li class="_2po2r cRfUr" title=""><span class=""><i
                        class="fa fa-ban _22XWG"></i>设置禁止转载</span></li>
                    </ul>
                  </span>
                </div>
                <span class="NariC">{{article.name}}</span>
                <span class="hLzJv">{{article.content}}</span>
                <span class="_29C-V">字数:{{article.content?article.content.length:0}}</span>
              </li>
            </ul>
            <div class="_2cVn3" @click="add_article(1)"><i class="fa fa-plus"></i><span> 在下方新建文章</span></div>
          </div>
        </div>
      </div>
      <input type="text" class="_24i7u" value="2020-01-12" v-if="article_list.length>0">
      <div id="editor" v-if="article_list.length>0">
        <mavon-editor
          style="height: 100%"
          v-model="editorContent"
          :ishljs="true"
          ref=md
          @imgAdd="imgAdd"
          @imgDel="imgDel"
        ></mavon-editor>
      </div>
    </div>
    <el-dialog
      title="定时发文"
      :visible.sync="dialogVisible"
      width="30%"
    >
      <div class="block">
        <span class="demonstration">选择定时发文的时间：</span>
        <el-date-picker
          v-model="pub_date"
          type="datetime"
          placeholder="选择定时发文的时间"
          align="right"
          :picker-options="pickerOptions">
        </el-date-picker>
        <div class="_3mEYS" v-if="pub_date">本文章将于<span class="yfqan">{{timeformat(pub_date)}}</span>发布。</div>
      </div>
      <span slot="footer" class="dialog-footer">
    <el-button @click="dialogVisible = false">取 消</el-button>
    <el-button type="primary" @click="interval_pub_article">确 定</el-button>
  </span>
    </el-dialog>
  </div>
</template>
<script>
    import {mavonEditor} from 'mavon-editor'
    import 'mavon-editor/dist/css/index.css'

    export default {
        name: "Write",
        data() {
            return {
                editorContent: "",
                img_file: [],
                collection_form: false,
                is_show_page: false,
                token: "",
                collection_list: [],     // 当前用户的文集列表
                current_collection: 0,  // 默认让用户选中的文集的下标为0
                is_show_collection_menu: false,    // 是否显示文集菜单
                collection_name: "",//新建文集name
                article_list: [],
                current_article: 0,     // 默认让用户选中的文章的下标为0
                is_show_article_menu: false,    // 是否显示文章菜单
                dialogVisible: false, //定时发布时间选择
                pickerOptions: {
                    shortcuts: [{
                        text: '今天',
                        onClick(picker) {
                            picker.$emit('pick', new Date());
                        }
                    }, {
                        text: '昨天',
                        onClick(picker) {
                            const date = new Date();
                            date.setTime(date.getTime() - 3600 * 1000 * 24);
                            picker.$emit('pick', date);
                        }
                    }, {
                        text: '一周前',
                        onClick(picker) {
                            const date = new Date();
                            date.setTime(date.getTime() - 3600 * 1000 * 24 * 7);
                            picker.$emit('pick', date);
                        }
                    }]
                },
                pub_date: '',
            }
        },
        watch: {
            editorContent() {
                console.log(this.editorContent)
            },
            current_collection() {
                let collection_id = this.collection_list[this.current_collection].id;
                this.get_article_list(collection_id);
                this.current_article = 0;
            },
            collection_list() {

                this.get_article_list();
            },
            current_article() {
                this.editorContent = this.article_list[this.current_article].content;
            },
            article_list() {
                if (this.current_article === this.article_list.length) {
                    this.current_article = this.current_article - 1;
                }
            },

        },
        created() {
            this.token = this.$settings.check_user_login(this);
            if (this.token) {
                this.is_show_page = true;
                this.get_collection();

            }
        },
        mounted() {

            if (this.article_list.length > 0) {
                document.querySelector("#editor").style.height = document.documentElement.clientHeight - document.querySelector("._24i7u").clientHeight + "px";
            }
            // 给当前网页绑定点击事件
            document.onclick = () => {
                // 点击文档,隐藏操作文集的的菜单
                this.is_show_collection_menu = false;
                this.is_show_article_menu = false;
            }
        },
        components: {
            mavonEditor
        },
        methods: {
            // 绑定@imgAdd event
            imgAdd(pos, $file) {
                // 添加文件
            },
            imgDel(pos) {
                // 删除文件
            },
            get_collection() {
                // 获取当前登陆用户的文集
                this.$axios.get(`${this.$settings.Host}/article/collection/`, {
                    headers: {
                        Authorization: "jwt " + this.token,
                    }
                }).then(response => {
                    this.collection_list = response.data;
                }).catch(error => {
                    this.$message.error("对不起,无法获取当前用户的文集列表!");
                    this.$settings.jump_page(this, "尊敬的游客, 您尚未登陆!请登陆后再进行操作!", "警告", "去登陆", "/user/login");
                });
            },
            collection_add() {
                if (!this.collection_name) {
                    this.$message.error("文集名称不能为空！")
                } else {
                    this.$axios.post(`${this.$settings.Host}/article/collection/create/`, {
                        name: this.collection_name,
                    }, {
                        headers: {
                            Authorization: "jwt " + this.token,
                        }
                    }).then(response => {
                        this.$message.success("添加文集成功！");
                        this.collection_name = '';
                        this.collection_form = false;
                        this.get_collection();
                        this.current_collection = 0;
                    }).catch(error => {
                        this.$message.error("添加文集失败！");
                    });
                }
            },
            edit_collection(collection_id) {
                // 修改文集
                this.$prompt('请输入新文集名', '提示', {
                    confirmButtonText: '确定',
                    cancelButtonText: '取消',
                    inputPattern: /.{1,}/,
                    inputErrorMessage: '文集名称不能为空!'
                }).then(({value}) => {
                    // 点击确定,需要把当前文集名称提交到服务端进行修改
                    this.$axios.put(`${this.$settings.Host}/article/collection/${collection_id}/`, {
                        name: value,
                    }, {
                        headers: {
                            Authorization: "jwt " + this.token,
                        }
                    }).then(response => {
                        this.get_collection();
                    }).catch(error => {
                        this.$message.error(error.response.data);
                    })
                }).catch(() => {

                });
            },
            del_collection(collection_id) {
                // 删除文集
                this.$axios.delete(`${this.$settings.Host}/article/collection/${collection_id}/`, {
                    headers: {
                        Authorization: "jwt " + this.token,
                    }
                }).then(response => {
                    this.get_collection();
                }).catch(error => {
                    this.$message.error(error.response.data);
                })

            },
            get_article_list() {
                // 获取文章列表
                let collection_id = this.collection_list[this.current_collection].id;
                this.$axios.get(`${this.$settings.Host}/article/`, {
                    params: {
                        collection: collection_id,
                    },
                    headers: {
                        Authorization: "jwt " + this.token,
                    }
                }).then(response => {
                    this.article_list = response.data;
                }).catch(error => {
                    this.$message.error(error.response.data);
                })
            },
            add_article(position) { // position 表示添加文章位置
                // 在前面添加文章
                this.$axios.post(`${this.$settings.Host}/article/`, {
                    position: position,
                    collection: this.collection_list[this.current_collection].id,
                }, {
                    headers: {
                        Authorization: "jwt " + this.token,
                    }
                }).then(response => {
                    let collection_id = this.collection_list[this.current_collection].id;
                    this.get_article_list(collection_id);
                }).catch(error => {
                    this.$message.error(error.response.data);
                })
            },
            del_article(article_id) {
                // 删除文集
                this.$axios.delete(`${this.$settings.Host}/article/${article_id}/`, {
                    headers: {
                        Authorization: "jwt " + this.token,
                    }
                }).then(response => {
                    this.get_article_list();
                }).catch(error => {
                    this.$message.error(error.response.data);
                })

            },
            public_article(is_public) {
                // 文章发布状态的切换
                let article_id = this.article_list[this.current_article].id;
                this.$axios.put(`${this.$settings.Host}/article/public/${article_id}/`, {
                    // is_public: is_public,
                }, {
                    headers: {
                        Authorization: "jwt " + this.token,
                    }
                }).then(response => {
                    this.get_article_list();
                    if (!is_public) {
                        this.$message.success("文章发布成功!");
                        // todo 接下来我们还需要对页面进行跳转到文章发布投稿页面
                    } else {
                        this.$message.success("文章设置成功!");
                    }
                }).catch(error => {
                    this.$message.error("操作失败!请联系客服工作人员!");
                })
            },
            move_article(collection_id) {
                // 文章发布状态的切换
                let article_id = this.article_list[this.current_article].id;
                this.$axios.put(`${this.$settings.Host}/article/move/${article_id}/`, {
                    collection_id: collection_id,
                }, {
                    headers: {
                        Authorization: "jwt " + this.token,
                    }
                }).then(response => {
                    this.get_article_list();
                    this.$message.success("文章设置成功!");

                }).catch(error => {
                    this.$message.error("操作失败!请联系客服工作人员!");
                })
            },
            interval_pub_article() {
                this.dialogVisible = false;
                // 定时发布文章
                let article_id = this.article_list[this.current_article].id;
                this.$axios.put(`${this.$settings.Host}/article/interval/${article_id}/`, {
                    pub_date: this.pub_date,
                }, {
                    headers: {
                        Authorization: "jwt " + this.token,
                    }
                }).then(response => {
                    this.$message.success("文章设置成功!");

                }).catch(error => {
                    this.$message.error("操作失败!请联系客服工作人员!");
                });
            },
            timeformat(time) {
                time = new Date(time);
                return `${time.getFullYear()}-${time.getMonth() + 1}-${time.getDate()} ${time.getHours()}:${time.getMinutes()}`;
            }
        }
    }
</script>
```

### 服务端提供修改pub_date发布时间的api接口

+ 配置文件中， 调整时区

  ```python
  # 必须设置为True，否则后面提交发布时间到服务端会报错！
  USE_TZ = True
  ```

+ views视图

  ```python
  class ArticleIntervalAPIView(APIView):
      """定时发布文章"""
      permission_classes = [IsAuthenticated]
      def put(self,request,pk):
          user = request.user
          try:
              article = Article.objects.get(pk=pk, user=user)
          except Article.DoesNotExist:
              return Response("对不起,当前文章不存在!", status=status.HTTP_400_BAD_REQUEST)
  
          pub_date = request.data.get("pub_date")
          article.pub_date = pub_date
          article.save()
          return Response("操作成功!")
  ```

+ urls 路由

  ```python
  from django.urls import path,re_path
  from . import views
  urlpatterns = [
  ……
      re_path("^interval/(?P<pk>\d+)/$", views.ArticleIntervalAPIView.as_view()),
  ]
  ```

  

### celery的定时任务使用

每分钟执行一次定时发布操作，让pub_date时间到了，则更新对应文章的发布状态。

+ 编写异步任务

  在mycelery中创建article任务目录，在目录下创建任务文件tasks.py

  ```python
  from mycelery.main import app
  from article.models import Article
  from datetime import datetime
  @app.task(name="interval_pub_article")
  def interval_pub_article():
      """定时发布文章"""
      article_list = Article.objects.filter(pub_date__lte=datetime.now(),pub_date__isnull=False)
      article_list.update(pub_date=None,is_public=True)
  ```

+ 注册异步任务到main.py中。并重启celery

  ```python
  import os
  from celery import Celery
  
  #初始化celery对象
  app = Celery("myrenranpro")
  
  
  # 把celery和django进行组合，识别和加载django的配置文件
  os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'renranapi.settings.dev')
  
  # 对django框架执行初始化
  import django
  django.setup()
  
  #加载配置
  app.config_from_object("mycelery.config")
  
  #注册异步任务
  # app.autodiscover_tasks(["任务1","任务2"])
  app.autodiscover_tasks(["mycelery.sms","mycelery.article"])
  # 启动Celery的命令
  # 强烈建议切换目录到mycelery根目录下启动
  # celery -A mycelery.main worker --loglevel=info
  ```

+ 使用celery的定时任务调度器，让celery定时执行异步任务。

  + Celery官方文档中关于定时任务使用的说明：

    ```python
    http://docs.celeryproject.org/en/latest/userguide/periodic-tasks.html
    ```

  +  在mycelery中config.py配置异步任务定时执行

    ```python
    # 任务队列的链接地址
    broker_url = 'redis://127.0.0.1:6379/15'
    # 结果队列的链接地址
    result_backend = 'redis://127.0.0.1:6379/14'
    
    # 定时任务调度器相关配置
    from .main import app
    from celery.schedules import crontab
    app.conf.beat_schedule = {
        # 定时任务列表
        'pub-article-every-one-minute': {
            'task': 'interval_pub_article', # 指定定时执行的的异步任务
            # 'schedule': crontab(),         # 时间间隔,一分钟
            'schedule': 10.0,               # 时间间隔,默认:秒
            # 'args': (16, 16)              # 如果任务有固定参数,则可以写在args
        },
    }
    
    # 和django框架同步时区
    from django.conf import settings
    app.conf.timezone = settings.TIME_ZONE
    
    # 完成上面的配置以后,重启celery并在新的终端窗口执行命令,运行定时任务的调度器
    # celery -A mycelery.main beat  # mycelery.main 是celery的主应用文件
    ```

  + 接下来，我们就可以重启Celery并启用Celery的定时任务调度器

    + 先在终端下，运行celery的定时任务程序，以下命令：

      ```bash
      celery -A mycelery.main beat  # mycelery.main 是celery的主应用文件
      ```

    + 然后再新建一个终端，运行以下命令，上面的命令必须先指定：

      ```
      celery -A mycelery.main worker --loglevel=info
      ```

      注意，使用的时候，如果有时区必须先配置好系统时区。

## 文章保存

### models

模型新增一个保存文章内容显示效果的字段render。

```python
class Article(BaseModel):
    """文章模型"""
    content = models.TextField(null=True, blank=True, verbose_name="文章内容")
    render = models.TextField(null=True, blank=True, verbose_name="文章内容[解析后]")
    user = models.ForeignKey(User, on_delete=models.DO_NOTHING, verbose_name="用户")
    collection = models.ForeignKey(ArticleCollection, on_delete=models.CASCADE, verbose_name="文集")
    pub_date = models.DateTimeField(null=True, default=None, verbose_name="发布时间")
    access_pwd = models.CharField(max_length=15,null=True, blank=True, verbose_name="访问密码")
    read_count = models.IntegerField(default=0, null=True, blank=True, verbose_name="阅读量")
    like_count = models.IntegerField(default=0, null=True, blank=True, verbose_name="点赞量")
    collect_count = models.IntegerField(default=0, null=True, blank=True, verbose_name="收藏量")
    comment_count = models.IntegerField(default=0, null=True, blank=True, verbose_name="评论量")
    reward_count = models.IntegerField(default=0, null=True, blank=True, verbose_name="赞赏量")
    is_public = models.BooleanField(default=False, verbose_name="是否公开")
    class Meta:
        db_table = "rr_article"
        verbose_name = "文章"
        verbose_name_plural = verbose_name
```



### views视图

```python
class ArticeUpdateAPIView(APIView):
    """文章标题和内容修改保存"""
    permission_classes = [IsAuthenticated]
    def put(self,request,pk):
        user = request.user
        try:
            article = Article.objects.get(pk=pk, user=user)
        except Article.DoesNotExist:
            return Response("对不起,当前文章不存在!", status=status.HTTP_400_BAD_REQUEST)

        article.name = request.data.get("name")
        article.content = request.data.get("content")
        article.render = request.data.get("render")
        article.save()
        return Response("操作成功!")
```

### urls 路由

```python
urlpatterns = [
	#……
    # 修改文章
    re_path("^save/(?P<pk>\d+)/$", views.ArticeUpdateAPIView.as_view()),
]
```

### 前端writer组件

+ 实现功能

  + 用户点击指定文章时，需要显示当前文章的标题和内容

  + 监听文章标题、内容，变化时自动发送ajax进行保存

  + 前端ajax节流

    > 现在用户每一次粒度很小的操纵都会导致前端发送一次ajax请求，所以我们可以通过定时器setTimeout来让ajax延时发送请求，例如，当用户进行修改操作时，我们可以调用setTimeout来让ajax2秒发送请求，如果2秒内，用户有继续操作了文章，则重新计算2秒。 这种解决问题的思路，在前端里面叫函数节流/ajax节流。

  ```vue
  <template>
    <div class="write" v-show="is_show_page">
      <div class="_2v5v5">
        <div class="_3zibT">
          <router-link to="/">回首页</router-link>
        </div>
        <div class="_1iZMb">
          <div class="_33Zlg" @click="collection_form=true"><i class="fa fa-plus"></i><span>新建文集</span></div>
          <div class="_2G97m">
            <form class="M8J6Q" :class="collection_form?'_2a1Rp':'_1mU5v'">
              <input type="text" placeholder="请输入文集名..." v-model="collection_name" class="_1CtV4">
              <button type="button" class="dwU8Q _3zXcJ _3QfkW" @click="collection_add"><span>提 交</span></button>
              <button type="button" class="vIzwB _3zXcJ" @click="collection_form=false"><span>取 消</span></button>
            </form>
          </div>
        </div>
        <ul class="_3MbJ4 _3t059">
          <li class="_3DM7w" :class="{_31PCv:current_collection==key}" 　:title="collection.name"
              v-for="collection,key in collection_list" :key="key">
            <div class="_3P4JX _2VLy-" v-if="current_collection==key"
                 @click.stop.prevent="is_show_collection_menu=!is_show_collection_menu">
              <i class="fa fa-gear"></i>
              <span>
                <ul class="_2V8zt _3FcHm _2w9pn" :class="{NvfK4:is_show_collection_menu}">
                  <li class="_2po2r cRfUr" title="" @click="edit_collection(collection.id)">
                    <span class=""><i class="fa fa-pencil-square-o _22XWG"></i>修改文集</span>
                  </li>
                  <li class="_2po2r cRfUr" title="" @click="del_collection(collection.id)">
                    <span class=""><i class="fa fa-trash-o _22XWG"></i>删除文集</span>
                  </li>
                </ul>
              </span>
            </div>
            <span @click="current_collection=key">{{collection.name}}</span>
          </li>
        </ul>
        <div style="height: 50px;"></div>
        <div role="button" class="h-5Am">
          <span class="ant-dropdown-trigger"><i class="fa fa-bars"></i><span>设置</span></span>
          <span class="Yv5Zx">遇到问题<i class="fa fa-question-circle-o"></i></span>
        </div>
      </div>
      <div class="rQQG7">
        <div class="_3revO _2mnPN">
          <div class="_3br9T">
            <div>
              <div class="_1GsW5" @click="add_article(0)"><i class="fa fa-plus-circle"></i><span> 新建文章</span></div>
              <ul class="_2TxA-">
                <li class="_25Ilv" :class="{_33nt7:current_article==key}" :title="article.name"
                    v-for="article,key in article_list" :key="key" @click="current_article=key">
                  <i class="_13kgp" :class="{_2m93u:article.is_public}"></i>
                  <div class="_3P4JX poOXI" v-if="current_article==key"
                       @click.stop="is_show_article_menu=!is_show_article_menu">
                    <i class="fa fa-gear"></i>
                    <span>
                      <ul class="_2V8zt _3FcHm _2w9pn" :class="{NvfK4:is_show_article_menu}">
                        <li class="_2po2r cRfUr" title="" v-if="!article.is_public"
                            @click="public_article(article.is_public)"><span class=""><i
                          class="fa fa-share _22XWG"></i>直接发布</span></li>
                        <li class="_2po2r cRfUr" title="" v-if="article.is_public"
                            @click="public_article(article.is_public)"><span class=""><i
                          class="fa fa-lock _22XWG"></i>设置隐私</span></li>
                        <li class="_2po2r cRfUr" title="" v-if="!article.is_public" @click="dialogVisible = true"><span
                          class=""><i
                          class="fa fa-clock-o _22XWG"></i>定时发布</span></li>
                        <li class="_2po2r cRfUr" title=""><span class="_20tIi"><i class="iconfont ic-paid _22XWG"></i>发布为付费文章</span></li>
                        <li class="_2po2r cRfUr" title=""><span class=""><i
                          class="iconfont ic-set _22XWG"></i>设置发布样式</span></li>
                        <li class="_3nZXj _2_WAp _3df2u _2po2r cRfUr" title=""><span class=""><i
                          class="fa fa-folder-open _22XWG"></i>移动文章
                          <div class="_3x4X_">
                            <ul class="_2KzJx oGKRI _3DXDE _2w9pn">
                              <li class="_2po2r cRfUr" :title="collection.name" v-for="collection in collection_list"
                                  v-if="collection.id!=article.collection" @click="move_article(collection.id)"><span
                                class="">{{collection.name}}</span></li>
                            </ul>
                          </div>
                        </span>
                        </li>
                        <li class="_2po2r cRfUr" title=""><span class=""><i
                          class="fa fa-history _22XWG"></i>历史版本</span></li>
                        <li class="_2po2r cRfUr" title="" @click="del_article(article.id)"><span class=""><i
                          class="fa fa-trash-o _22XWG"></i>删除文章</span></li>
                        <li class="_2po2r cRfUr" title=""><span class=""><i
                          class="fa fa-ban _22XWG"></i>设置禁止转载</span></li>
                      </ul>
                    </span>
                  </div>
                  <span class="NariC">{{article.name}}</span>
                  <span class="hLzJv">{{article.content}}</span>
                  <span class="_29C-V">字数:{{article.content?article.content.length:0}}</span>
                </li>
              </ul>
              <div class="_2cVn3" @click="add_article(1)"><i class="fa fa-plus"></i><span> 在下方新建文章</span></div>
            </div>
          </div>
        </div>
        <input type="text" class="_24i7u" @input="change_title" v-model="articleTitle" v-if="article_list.length>0">
        <div id="editor" v-if="article_list.length>0">
          <mavon-editor
            style="height: 100%"
            v-model="articleContent"
            @change="change_article"
            :ishljs="true"
            ref=md
            @imgAdd="imgAdd"
            @imgDel="imgDel"
          ></mavon-editor>
        </div>
      </div>
      <el-dialog
        title="定时发文"
        :visible.sync="dialogVisible"
        width="30%"
      >
        <div class="block">
          <span class="demonstration">选择定时发文的时间：</span>
          <el-date-picker
            v-model="pub_date"
            type="datetime"
            placeholder="选择定时发文的时间"
            align="right"
            :picker-options="pickerOptions">
          </el-date-picker>
          <div class="_3mEYS" v-if="pub_date">本文章将于<span class="yfqan">{{timeformat(pub_date)}}</span>发布。</div>
        </div>
        <span slot="footer" class="dialog-footer">
      <el-button @click="dialogVisible = false">取 消</el-button>
      <el-button type="primary" @click="interval_pub_article">确 定</el-button>
    </span>
      </el-dialog>
    </div>
  </template>
  <script>
      import {mavonEditor} from 'mavon-editor'
      import 'mavon-editor/dist/css/index.css'
  
      export default {
          name: "Write",
          data() {
              return {
                  articleContent: '',
                  articleTitle: "",
                  articleRender: "",
                  img_file: [],
                  collection_form: false,
                  is_show_page: false,
                  token: "",
                  collection_list: [],     // 当前用户的文集列表
                  current_collection: 0,  // 默认让用户选中的文集的下标为0
                  is_show_collection_menu: false,    // 是否显示文集菜单
                  collection_name: "",//新建文集name
                  article_list: [],
                  current_article: 0,     // 默认让用户选中的文章的下标为0
                  is_show_article_menu: false,    // 是否显示文章菜单
                  dialogVisible: false, //定时发布时间选择
                  pickerOptions: {
                      shortcuts: [{
                          text: '今天',
                          onClick(picker) {
                              picker.$emit('pick', new Date());
                          }
                      }, {
                          text: '昨天',
                          onClick(picker) {
                              const date = new Date();
                              date.setTime(date.getTime() - 3600 * 1000 * 24);
                              picker.$emit('pick', date);
                          }
                      }, {
                          text: '一周前',
                          onClick(picker) {
                              const date = new Date();
                              date.setTime(date.getTime() - 3600 * 1000 * 24 * 7);
                              picker.$emit('pick', date);
                          }
                      }]
                  },
                  pub_date: '',
                  timer: "",
              }
          },
          watch: {
              // editorContent() {
              //     console.log(this.editorContent)
              // },
              current_collection() {
                  let collection_id = this.collection_list[this.current_collection].id;
                  this.get_article_list();
                  this.current_article = 0;
                  this.get_current_article();
              },
              collection_list() {
                  this.get_article_list();
              },
              article_list() {
                  if (this.current_article === this.article_list.length) {
                      this.current_article = this.current_article - 1;
                  }
                  if(this.article_list){
                      this.get_current_article();
                  }
  
              },
              current_article() {
                  this.get_current_article();
              },
  
          },
          created() {
              this.token = this.$settings.check_user_login(this);
              if (this.token) {
                  this.is_show_page = true;
                  this.get_collection();
              }
          },
          mounted() {
  
              if (this.article_list.length > 0) {
                  document.querySelector("#editor").style.height = document.documentElement.clientHeight - document.querySelector("._24i7u").clientHeight + "px";
              }
              // 给当前网页绑定点击事件
              document.onclick = () => {
                  // 点击文档,隐藏操作文集的的菜单
                  this.is_show_collection_menu = false;
                  this.is_show_article_menu = false;
              }
          },
          components: {
              mavonEditor
          },
          methods: {
              // 绑定@imgAdd event
              imgAdd(pos, $file) {
                  // 添加文件
              },
              imgDel(pos) {
                  // 删除文件
              },
              get_collection() {
                  // 获取当前登陆用户的文集
                  this.$axios.get(`${this.$settings.Host}/article/collection/`, {
                      headers: {
                          Authorization: "jwt " + this.token,
                      }
                  }).then(response => {
                      this.collection_list = response.data;
                  }).catch(error => {
                      this.$message.error("对不起,无法获取当前用户的文集列表!");
                      this.$settings.jump_page(this, "尊敬的游客, 您尚未登陆!请登陆后再进行操作!", "警告", "去登陆", "/user/login");
                  });
              },
              collection_add() {
                  if (!this.collection_name) {
                      this.$message.error("文集名称不能为空！")
                  } else {
                      this.$axios.post(`${this.$settings.Host}/article/collection/create/`, {
                          name: this.collection_name,
                      }, {
                          headers: {
                              Authorization: "jwt " + this.token,
                          }
                      }).then(response => {
                          this.$message.success("添加文集成功！");
                          this.collection_name = '';
                          this.collection_form = false;
                          this.get_collection();
                          this.current_collection = 0;
                      }).catch(error => {
                          this.$message.error("添加文集失败！");
                      });
                  }
              },
              edit_collection(collection_id) {
                  // 修改文集
                  this.$prompt('请输入新文集名', '提示', {
                      confirmButtonText: '确定',
                      cancelButtonText: '取消',
                      inputPattern: /.{1,}/,
                      inputErrorMessage: '文集名称不能为空!'
                  }).then(({value}) => {
                      // 点击确定,需要把当前文集名称提交到服务端进行修改
                      this.$axios.put(`${this.$settings.Host}/article/collection/${collection_id}/`, {
                          name: value,
                      }, {
                          headers: {
                              Authorization: "jwt " + this.token,
                          }
                      }).then(response => {
                          this.get_collection();
                      }).catch(error => {
                          this.$message.error(error.response.data);
                      })
                  }).catch(() => {
  
                  });
              },
              del_collection(collection_id) {
                  // 删除文集
                  this.$axios.delete(`${this.$settings.Host}/article/collection/${collection_id}/`, {
                      headers: {
                          Authorization: "jwt " + this.token,
                      }
                  }).then(response => {
                      this.get_collection();
                  }).catch(error => {
                      this.$message.error(error.response.data);
                  })
  
              },
              get_article_list() {
                  // 获取文章列表
                  let collection_id = this.collection_list[this.current_collection].id;
                  this.$axios.get(`${this.$settings.Host}/article/`, {
                      params: {
                          collection: collection_id,
                      },
                      headers: {
                          Authorization: "jwt " + this.token,
                      }
                  }).then(response => {
                      this.article_list = response.data;
                  }).catch(error => {
                      this.$message.error(error.response.data);
                  })
              },
              get_current_article() {
                  this.articleContent = this.article_list[this.current_article].content ? this.article_list[this.current_article].content : '';
                  this.articleTitle = this.article_list[this.current_article].name ? this.article_list[this.current_article].name : "";
              },
              add_article(position) { // position 表示添加文章位置
                  // 在前面添加文章
                  this.$axios.post(`${this.$settings.Host}/article/`, {
                      position: position,
                      collection: this.collection_list[this.current_collection].id,
                  }, {
                      headers: {
                          Authorization: "jwt " + this.token,
                      }
                  }).then(response => {
                      let collection_id = this.collection_list[this.current_collection].id;
                      this.get_article_list(collection_id);
                  }).catch(error => {
                      this.$message.error(error.response.data);
                  })
              },
              del_article(article_id) {
                  // 删除文集
                  this.$axios.delete(`${this.$settings.Host}/article/${article_id}/`, {
                      headers: {
                          Authorization: "jwt " + this.token,
                      }
                  }).then(response => {
                      this.get_article_list();
                  }).catch(error => {
                      this.$message.error(error.response.data);
                  })
  
              },
              public_article(is_public) {
                  // 文章发布状态的切换
                  let article_id = this.article_list[this.current_article].id;
                  this.$axios.put(`${this.$settings.Host}/article/public/${article_id}/`, {
                      // is_public: is_public,
                  }, {
                      headers: {
                          Authorization: "jwt " + this.token,
                      }
                  }).then(response => {
                      this.get_article_list();
                      if (!is_public) {
                          this.$message.success("文章发布成功!");
                          // todo 接下来我们还需要对页面进行跳转到文章发布投稿页面
                      } else {
                          this.$message.success("文章设置成功!");
                      }
                  }).catch(error => {
                      this.$message.error("操作失败!请联系客服工作人员!");
                  })
              },
              move_article(collection_id) {
                  // 文章发布状态的切换
                  let article_id = this.article_list[this.current_article].id;
                  this.$axios.put(`${this.$settings.Host}/article/move/${article_id}/`, {
                      collection_id: collection_id,
                  }, {
                      headers: {
                          Authorization: "jwt " + this.token,
                      }
                  }).then(response => {
                      this.get_article_list();
                      this.$message.success("文章设置成功!");
  
                  }).catch(error => {
                      this.$message.error("操作失败!请联系客服工作人员!");
                  })
              },
              interval_pub_article() {
                  this.dialogVisible = false;
                  // 定时发布文章
                  let article_id = this.article_list[this.current_article].id;
                  this.$axios.put(`${this.$settings.Host}/article/interval/${article_id}/`, {
                      pub_date: this.pub_date,
                  }, {
                      headers: {
                          Authorization: "jwt " + this.token,
                      }
                  }).then(response => {
                      this.$message.success("文章设置成功!");
  
                  }).catch(error => {
                      this.$message.error("操作失败!请联系客服工作人员!");
                  });
              },
              timeformat(time) {
                  time = new Date(time);
                  return `${time.getFullYear()}-${time.getMonth() + 1}-${time.getDate()} ${time.getHours()}:${time.getMinutes()}`;
              },
              change_article(value, render) {
                  // 监听value-原始内容，render-解析后的内容
                  this.articleContent = value;
                  this.articleRender = render;
                  clearTimeout(this.timer);
                  this.timer = setTimeout(this.save_article, 2000);
  
              },
              change_title() {
                  this.save_article();
              },
              save_article() {
                  // 保存文章
                  let article_id = this.article_list[this.current_article].id;
                  this.$axios.put(`${this.$settings.Host}/article/save/${article_id}/`, {
                      name: this.articleTitle,
                      content: this.articleContent,
                      render: this.articleRender,
                  }, {
                      headers: {
                          Authorization: "jwt " + this.token,
                      }
                  }).then(response => {
                      this.get_article_list();
                      // this.$message.success("保存成功!");
                  }).catch(error => {
                      this.$message.error("保存失败!");
                  })
              }
          }
      }
  </script>
  ```

  

## 完善富文本编辑器添加图片到服务端功能

+ views 视图

  ```python
  class ImageAPIView(CreateAPIView):
      """保存文章上传的图片"""
      permission_classes = [IsAuthenticated]
  
      queryset = ArticleImage.objects.all()
      serializer_class = ArticleImageModelSerializer
  ```

+ serializers 序列化器

  ```python
  from rest_framework import serializers
  from .models import ArticleImage
  
  class ArticleImageModelSerializer(serializers.ModelSerializer):
      class Meta:
          model = ArticleImage
          fields = ("image",)
  
      def create(self, validated_data):
          user = self.context["request"].user
          print(user.id,9999)
          instance = ArticleImage.objects.create(image=validated_data.get("image"), user=user.id)
          instance.group = str(instance.image).split("/",1)[0]
          instance.save()
          return instance
  ```

+ urls 路由

  ```python
  urlpatterns = [
      path("uploadimg/", views.ImageAPIView.as_view()),
  ]
  ```

+ writer 组件

  ```vue
  <template>
    <div class="write" v-show="is_show_page">
      <div class="_2v5v5">
        <div class="_3zibT">
          <router-link to="/">回首页</router-link>
        </div>
        <div class="_1iZMb">
          <div class="_33Zlg" @click="collection_form=true"><i class="fa fa-plus"></i><span>新建文集</span></div>
          <div class="_2G97m">
            <form class="M8J6Q" :class="collection_form?'_2a1Rp':'_1mU5v'">
              <input type="text" placeholder="请输入文集名..." v-model="collection_name" class="_1CtV4">
              <button type="button" class="dwU8Q _3zXcJ _3QfkW" @click="collection_add"><span>提 交</span></button>
              <button type="button" class="vIzwB _3zXcJ" @click="collection_form=false"><span>取 消</span></button>
            </form>
          </div>
        </div>
        <ul class="_3MbJ4 _3t059">
          <li class="_3DM7w" :class="{_31PCv:current_collection==key}" 　:title="collection.name"
              v-for="collection,key in collection_list" :key="key">
            <div class="_3P4JX _2VLy-" v-if="current_collection==key"
                 @click.stop.prevent="is_show_collection_menu=!is_show_collection_menu">
              <i class="fa fa-gear"></i>
              <span>
                <ul class="_2V8zt _3FcHm _2w9pn" :class="{NvfK4:is_show_collection_menu}">
                  <li class="_2po2r cRfUr" title="" @click="edit_collection(collection.id)">
                    <span class=""><i class="fa fa-pencil-square-o _22XWG"></i>修改文集</span>
                  </li>
                  <li class="_2po2r cRfUr" title="" @click="del_collection(collection.id)">
                    <span class=""><i class="fa fa-trash-o _22XWG"></i>删除文集</span>
                  </li>
                </ul>
              </span>
            </div>
            <span @click="current_collection=key">{{collection.name}}</span>
          </li>
        </ul>
        <div style="height: 50px;"></div>
        <div role="button" class="h-5Am">
          <span class="ant-dropdown-trigger"><i class="fa fa-bars"></i><span>设置</span></span>
          <span class="Yv5Zx">遇到问题<i class="fa fa-question-circle-o"></i></span>
        </div>
      </div>
      <div class="rQQG7">
        <div class="_3revO _2mnPN">
          <div class="_3br9T">
            <div>
              <div class="_1GsW5" @click="add_article(0)"><i class="fa fa-plus-circle"></i><span> 新建文章</span></div>
              <ul class="_2TxA-">
                <li class="_25Ilv" :class="{_33nt7:current_article==key}" :title="article.name"
                    v-for="article,key in article_list" :key="key" @click="current_article=key">
                  <i class="_13kgp" :class="{_2m93u:article.is_public}"></i>
                  <div class="_3P4JX poOXI" v-if="current_article==key"
                       @click.stop="is_show_article_menu=!is_show_article_menu">
                    <i class="fa fa-gear"></i>
                    <span>
                      <ul class="_2V8zt _3FcHm _2w9pn" :class="{NvfK4:is_show_article_menu}">
                        <li class="_2po2r cRfUr" title="" v-if="!article.is_public"
                            @click="public_article(article.is_public)"><span class=""><i
                          class="fa fa-share _22XWG"></i>直接发布</span></li>
                        <li class="_2po2r cRfUr" title="" v-if="article.is_public"
                            @click="public_article(article.is_public)"><span class=""><i
                          class="fa fa-lock _22XWG"></i>设置隐私</span></li>
                        <li class="_2po2r cRfUr" title="" v-if="!article.is_public" @click="dialogVisible = true"><span
                          class=""><i
                          class="fa fa-clock-o _22XWG"></i>定时发布</span></li>
                        <li class="_2po2r cRfUr" title=""><span class="_20tIi"><i class="iconfont ic-paid _22XWG"></i>发布为付费文章</span></li>
                        <li class="_2po2r cRfUr" title=""><span class=""><i
                          class="iconfont ic-set _22XWG"></i>设置发布样式</span></li>
                        <li class="_3nZXj _2_WAp _3df2u _2po2r cRfUr" title=""><span class=""><i
                          class="fa fa-folder-open _22XWG"></i>移动文章
                          <div class="_3x4X_">
                            <ul class="_2KzJx oGKRI _3DXDE _2w9pn">
                              <li class="_2po2r cRfUr" :title="collection.name" v-for="collection in collection_list"
                                  v-if="collection.id!=article.collection" @click="move_article(collection.id)"><span
                                class="">{{collection.name}}</span></li>
                            </ul>
                          </div>
                        </span>
                        </li>
                        <li class="_2po2r cRfUr" title=""><span class=""><i
                          class="fa fa-history _22XWG"></i>历史版本</span></li>
                        <li class="_2po2r cRfUr" title="" @click="del_article(article.id)"><span class=""><i
                          class="fa fa-trash-o _22XWG"></i>删除文章</span></li>
                        <li class="_2po2r cRfUr" title=""><span class=""><i
                          class="fa fa-ban _22XWG"></i>设置禁止转载</span></li>
                      </ul>
                    </span>
                  </div>
                  <span class="NariC">{{article.name}}</span>
                  <span class="hLzJv">{{article.content}}</span>
                  <span class="_29C-V">字数:{{article.content?article.content.length:0}}</span>
                </li>
              </ul>
              <div class="_2cVn3" @click="add_article(1)"><i class="fa fa-plus"></i><span> 在下方新建文章</span></div>
            </div>
          </div>
        </div>
        <input type="text" class="_24i7u" @input="change_title" v-model="articleTitle" v-if="article_list.length>0">
        <div id="editor" v-if="article_list.length>0">
          <mavon-editor
            style="height: 100%"
            v-model="articleContent"
            @change="change_article"
            :ishljs="true"
            ref=md
            @imgAdd="imgAdd"
            @imgDel="imgDel"
          ></mavon-editor>
        </div>
      </div>
      <el-dialog
        title="定时发文"
        :visible.sync="dialogVisible"
        width="30%"
      >
        <div class="block">
          <span class="demonstration">选择定时发文的时间：</span>
          <el-date-picker
            v-model="pub_date"
            type="datetime"
            placeholder="选择定时发文的时间"
            align="right"
            :picker-options="pickerOptions">
          </el-date-picker>
          <div class="_3mEYS" v-if="pub_date">本文章将于<span class="yfqan">{{timeformat(pub_date)}}</span>发布。</div>
        </div>
        <span slot="footer" class="dialog-footer">
      <el-button @click="dialogVisible = false">取 消</el-button>
      <el-button type="primary" @click="interval_pub_article">确 定</el-button>
    </span>
      </el-dialog>
    </div>
  </template>
  <script>
      import {mavonEditor} from 'mavon-editor'
      import 'mavon-editor/dist/css/index.css'
  
      export default {
          name: "Write",
          data() {
              return {
                  articleContent: '',
                  articleTitle: "",
                  articleRender: "",
                  img_file: [],
                  collection_form: false,
                  is_show_page: false,
                  token: "",
                  collection_list: [],     // 当前用户的文集列表
                  current_collection: 0,  // 默认让用户选中的文集的下标为0
                  is_show_collection_menu: false,    // 是否显示文集菜单
                  collection_name: "",//新建文集name
                  article_list: [],
                  current_article: 0,     // 默认让用户选中的文章的下标为0
                  is_show_article_menu: false,    // 是否显示文章菜单
                  dialogVisible: false, //定时发布时间选择
                  pickerOptions: {
                      shortcuts: [{
                          text: '今天',
                          onClick(picker) {
                              picker.$emit('pick', new Date());
                          }
                      }, {
                          text: '昨天',
                          onClick(picker) {
                              const date = new Date();
                              date.setTime(date.getTime() - 3600 * 1000 * 24);
                              picker.$emit('pick', date);
                          }
                      }, {
                          text: '一周前',
                          onClick(picker) {
                              const date = new Date();
                              date.setTime(date.getTime() - 3600 * 1000 * 24 * 7);
                              picker.$emit('pick', date);
                          }
                      }]
                  },
                  pub_date: '',
                  timer: "",
              }
          },
          watch: {
              // editorContent() {
              //     console.log(this.editorContent)
              // },
              current_collection() {
                  let collection_id = this.collection_list[this.current_collection].id;
                  this.get_article_list();
                  this.current_article = 0;
                  this.get_current_article();
              },
              collection_list() {
                  this.get_article_list();
              },
              article_list() {
                  if (this.current_article === this.article_list.length) {
                      this.current_article = this.current_article - 1;
                  }
                  if (this.article_list) {
                      this.get_current_article();
                  }
  
              },
              current_article() {
                  this.get_current_article();
              },
  
          },
          created() {
              this.token = this.$settings.check_user_login(this);
              if (this.token) {
                  this.is_show_page = true;
                  this.get_collection();
              }
          },
          mounted() {
  
              if (this.article_list.length > 0) {
                  document.querySelector("#editor").style.height = document.documentElement.clientHeight - document.querySelector("._24i7u").clientHeight + "px";
              }
              // 给当前网页绑定点击事件
              document.onclick = () => {
                  // 点击文档,隐藏操作文集的的菜单
                  this.is_show_collection_menu = false;
                  this.is_show_article_menu = false;
              }
          },
          components: {
              mavonEditor
          },
          methods: {
              // 绑定@imgAdd event
              imgAdd(pos, $file) {
                  // 第一步.将图片上传到服务器.
                  var formdata = new FormData();
                  formdata.append('image', $file);
                  this.img_file[pos] = $file;
                  this.$axios.post(`${this.$settings.Host}/article/uploadimg/`, formdata, {
                      'Content-Type': 'multipart/form-data',
                      headers: {
                          Authorization: "jwt " + this.token,
                      }
                  }).then((res) => {
                      let _res = res.data;
                      // 第二步.将返回的url替换到文本原位置![...](0) -> ![...](url)
                      this.$refs.md.$img2Url(pos, _res.image);
                  });
              },
              imgDel(pos) {
                  delete this.img_file[pos];
              },
              
          }
      }
  </script>
  ```

  